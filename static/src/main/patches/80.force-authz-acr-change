diff -aurN shibboleth-idp/conf/authn/oxauth-authn-config.xml.orig shibboleth-idp/conf/authn/oxauth-authn-config.xml
--- shibboleth-idp/conf/authn/oxauth-authn-config.xml.orig    2021-02-02 12:46:00.000000000 +0000
+++ shibboleth-idp/conf/authn/oxauth-authn-config.xml 2021-09-13 16:46:21.944326965 +0000
@@ -27,7 +27,7 @@
     You would normally only unset this if you plan to return a fully decorated Java Subject from your
     external authentication source.
     -->
-    <util:constant id="shibboleth.authn.External.addDefaultPrincipals" static-field="java.lang.Boolean.TRUE" />
+    <util:constant id="shibboleth.authn.oxAuth.addDefaultPrincipals" static-field="java.lang.Boolean.TRUE" />

     <!--
     <bean id="shibboleth.authn.External.matchExpression" class="java.util.regex.Pattern" factory-method="compile"
diff -aurN shibboleth-idp/system/flows/authn/authn-beans.xml.orig shibboleth-idp/system/flows/authn/authn-beans.xml
--- shibboleth-idp/system/flows/authn/authn-beans.xml.orig    2020-06-02 15:56:00.000000000 +0000
+++ shibboleth-idp/system/flows/authn/authn-beans.xml 2021-09-10 11:45:08.410184464 +0000
@@ -50,6 +50,9 @@

     <bean id="FilterFlowsByForcedAuthn"
         class="net.shibboleth.idp.authn.impl.FilterFlowsByForcedAuthn" scope="prototype" />
+
+    <bean id="FilterFlowsByAcrChangedAuthn"
+        class="org.gluu.idp.externalauth.FilterFlowsByAcrChangedAuthn" scope="prototype" />

     <bean id="FilterFlowsByNonBrowserSupport"
         class="net.shibboleth.idp.authn.impl.FilterFlowsByNonBrowserSupport" scope="prototype" />
diff -aurN shibboleth-idp/system/flows/authn/authn-flow.xml.orig shibboleth-idp/system/flows/authn/authn-flow.xml
--- shibboleth-idp/system/flows/authn/authn-flow.xml.orig     2020-06-02 15:56:00.000000000 +0000
+++ shibboleth-idp/system/flows/authn/authn-flow.xml  2021-09-09 19:15:39.974233323 +0000
@@ -36,6 +36,7 @@
     <action-state id="FilterFlows">
         <evaluate expression="InitializeRequestedPrincipalContext" />
         <evaluate expression="FilterFlowsByForcedAuthn" />
+        <evaluate expression="FilterFlowsByAcrChangedAuthn" />
         <evaluate expression="FilterFlowsByNonBrowserSupport" />
         <evaluate expression="'proceed'" />

diff -aurN shibboleth-idp/flows/authn/oxAuth/oxauth-authn-beans.xml.orig shibboleth-idp/flows/authn/oxAuth/oxauth-authn-beans.xml
--- shibboleth-idp/flows/authn/oxAuth/oxauth-authn-beans.xml.orig     2021-02-02 12:46:00.000000000 +0000
+++ shibboleth-idp/flows/authn/oxAuth/oxauth-authn-beans.xml  2021-09-10 11:23:09.360348200 +0000
@@ -25,8 +25,8 @@

     <import resource="../../../conf/authn/oxauth-authn-config.xml" />

-    <bean id="ValidateExternalAuthentication"
-          class="net.shibboleth.idp.authn.impl.ValidateExternalAuthentication" scope="prototype"
+    <bean id="OxAuthValidateExternalAuthentication"
+          class="org.gluu.idp.externalauth.OxAuthValidateExternalAuthentication" scope="prototype"
           p:matchExpression="#{getObject('shibboleth.authn.oxAuth.matchExpression')}"
           p:addDefaultPrincipals="#{getObject('shibboleth.authn.oxAuth.addDefaultPrincipals') ?: true}"
           p:classifiedMessages-ref="shibboleth.authn.oxAuth.ClassifiedMessageMap"
diff -aurN shibboleth-idp/flows/authn/oxAuth/oxauth-authn-flow.xml.orig shibboleth-idp/flows/authn/oxAuth/oxauth-authn-flow.xml
--- shibboleth-idp/flows/authn/oxAuth/oxauth-authn-flow.xml.orig      2021-02-02 12:46:00.000000000 +0000
+++ shibboleth-idp/flows/authn/oxAuth/oxauth-authn-flow.xml   2021-09-10 11:24:00.068621234 +0000
@@ -13,7 +13,7 @@
     </view-state>

     <action-state id="ValidateExternalAuthentication">
-        <evaluate expression="ValidateExternalAuthentication" />
+        <evaluate expression="OxAuthValidateExternalAuthentication" />
         <evaluate expression="PopulateSubjectCanonicalizationContext" />
         <evaluate expression="'proceed'" />

