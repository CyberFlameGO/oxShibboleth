diff -aurN --ignore-all-space shibboleth-idp-3.3.3.orig/conf/authn/general-authn.xml shibboleth-idp-3.3.3.gluu/conf/authn/general-authn.xml
--- shibboleth-idp-3.3.3.orig/conf/authn/general-authn.xml	2019-07-07 11:18:14.964749300 +0300
+++ shibboleth-idp-3.3.3.gluu/conf/authn/general-authn.xml	2019-05-22 17:27:42.916581000 +0300
@@ -25,6 +25,7 @@
     expressions for password-based authentication over a secure channel, so anything more exotic requires
     customization, as the examples below for IP address and SPNEGO authentication illustrate.
     -->
+    <import resource="oxauth-supported-principals.xml"/>

     <util:list id="shibboleth.AvailableAuthenticationFlows">

@@ -124,6 +125,7 @@
             </property>
         </bean>

+       <ref bean="authn/oxAuth"/>
     </util:list>

     <!--
diff -aurN --ignore-all-space shibboleth-idp-3.3.3.orig/conf/authn/oxauth-authn-config.xml shibboleth-idp-3.3.3.gluu/conf/authn/oxauth-authn-config.xml
--- shibboleth-idp-3.3.3.orig/conf/authn/oxauth-authn-config.xml	1970-01-01 03:00:00.000000000 +0300
+++ shibboleth-idp-3.3.3.gluu/conf/authn/oxauth-authn-config.xml	2019-02-22 10:08:15.498128200 +0300
@@ -0,0 +1,70 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<beans xmlns="http://www.springframework.org/schema/beans"
+       xmlns:context="http://www.springframework.org/schema/context"
+       xmlns:util="http://www.springframework.org/schema/util"
+       xmlns:p="http://www.springframework.org/schema/p"
+       xmlns:c="http://www.springframework.org/schema/c"
+       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
+                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
+                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"
+                           
+       default-init-method="initialize"
+       default-destroy-method="destroy">
+
+    <!-- Servlet context-relative path to wherever your implementation lives. -->
+    <bean id="shibboleth.authn.oxAuth.externalAuthnPath" class="java.lang.String"
+          c:_0="contextRelative:Authn/oxAuth" />
+
+    <!--
+    Default is to always use the path in the bean above. If you want to determine it
+    dynamically, define a bean called "shibboleth.authn.External.externalAuthnPathStrategy"
+    of type Function<ProfileRequestContext,String> that returns the path to use.
+    -->
+
+    <!--
+    Add authentication flow descriptor's supportedPrincipals collection to the resulting Subject?
+    You would normally only unset this if you plan to return a fully decorated Java Subject from your
+    external authentication source.
+    -->
+    <util:constant id="shibboleth.authn.External.addDefaultPrincipals" static-field="java.lang.Boolean.TRUE" />
+
+    <!--
+    <bean id="shibboleth.authn.External.matchExpression" class="java.util.regex.Pattern" factory-method="compile"
+        c:_0="^(.+)@example\.edu]$" />
+    -->
+
+    <!--
+    Define entries here to map error messages returned by external modules and classify them as particular
+    kinds of errors for use in your templates and as events in flows.
+
+    Keys are events to signal, values are error codes.
+
+    The examples here just allow external signaling of the exact type of condition to record.
+    
+    If you want to "fall-through" to other login flows, include a mapping to "ReselectFlow".
+    -->
+    <util:map id="shibboleth.authn.oxAuth.ClassifiedMessageMap">
+        <entry key="AuthenticationException">
+            <list>
+                <value>AuthenticationException</value>
+            </list>
+        </entry>
+        <entry key="InvalidAuthenticationContext">
+            <list>
+                <value>InvalidAuthenticationContext</value>
+            </list>
+        </entry>
+        <entry key="NoPassive">
+            <list>
+                <value>NoPassive</value>
+            </list>
+        </entry>
+        <entry key="NoCredentials">
+            <list>
+                <value>InvalidToken</value>
+            </list>
+        </entry>
+    </util:map>
+    
+</beans>
diff -aurN --ignore-all-space shibboleth-idp-3.3.3.orig/flows/authn/oxAuth/oxauth-authn-beans.xml shibboleth-idp-3.3.3.gluu/flows/authn/oxAuth/oxauth-authn-beans.xml
--- shibboleth-idp-3.3.3.orig/flows/authn/oxAuth/oxauth-authn-beans.xml	1970-01-01 03:00:00.000000000 +0300
+++ shibboleth-idp-3.3.3.gluu/flows/authn/oxAuth/oxauth-authn-beans.xml	2019-02-22 10:08:15.539180300 +0300
@@ -0,0 +1,39 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<beans xmlns="http://www.springframework.org/schema/beans"
+       xmlns:context="http://www.springframework.org/schema/context"
+       xmlns:util="http://www.springframework.org/schema/util"
+       xmlns:p="http://www.springframework.org/schema/p"
+       xmlns:c="http://www.springframework.org/schema/c"
+       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
+                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
+                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"
+
+       default-init-method="initialize"
+       default-destroy-method="destroy">
+    
+    <bean class="org.springframework.context.support.PropertySourcesPlaceholderConfigurer"
+          p:placeholderPrefix="%{" p:placeholderSuffix="}" />
+
+    <bean class="net.shibboleth.ext.spring.config.IdentifiableBeanPostProcessor" />
+    <bean class="net.shibboleth.idp.profile.impl.ProfileActionBeanPostProcessor" />
+
+    <!-- Default strategy function to obtain the external path. -->
+    <bean id="shibboleth.authn.oxAuth.externalAuthnPathStrategy"
+          class="com.google.common.base.Functions" factory-method="constant"
+          c:_0-ref="shibboleth.authn.oxAuth.externalAuthnPath" />
+
+    <import resource="../../../conf/authn/oxauth-authn-config.xml" />
+
+    <bean id="ValidateExternalAuthentication"
+          class="net.shibboleth.idp.authn.impl.ValidateExternalAuthentication" scope="prototype"
+          p:matchExpression="#{getObject('shibboleth.authn.oxAuth.matchExpression')}"
+          p:addDefaultPrincipals="#{getObject('shibboleth.authn.oxAuth.addDefaultPrincipals') ?: true}"
+          p:classifiedMessages-ref="shibboleth.authn.oxAuth.ClassifiedMessageMap"
+          p:resultCachingPredicate="#{getObject('shibboleth.authn.oxAuth.resultCachingPredicate')}" />
+
+    <bean id="PopulateSubjectCanonicalizationContext"
+          class="net.shibboleth.idp.authn.impl.PopulateSubjectCanonicalizationContext" scope="prototype"
+          p:availableFlows-ref="shibboleth.PostLoginSubjectCanonicalizationFlows" />
+
+</beans>
diff -aurN --ignore-all-space shibboleth-idp-3.3.3.orig/flows/authn/oxAuth/oxauth-authn-flow.xml shibboleth-idp-3.3.3.gluu/flows/authn/oxAuth/oxauth-authn-flow.xml
--- shibboleth-idp-3.3.3.orig/flows/authn/oxAuth/oxauth-authn-flow.xml	1970-01-01 03:00:00.000000000 +0300
+++ shibboleth-idp-3.3.3.gluu/flows/authn/oxAuth/oxauth-authn-flow.xml	2019-02-22 10:08:15.539180300 +0300
@@ -0,0 +1,35 @@
+<flow xmlns="http://www.springframework.org/schema/webflow"
+      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow.xsd"
+      parent="authn.abstract">
+
+    <!-- This is a login flow for external authentication handled outside the webflow engine. -->
+
+    <view-state id="ExternalTransfer" view="externalRedirect:#{T(net.shibboleth.idp.authn.ExternalAuthentication).getExternalRedirect(flowRequestContext.getActiveFlow().getApplicationContext().getBean('shibboleth.authn.oxAuth.externalAuthnPathStrategy').apply(opensamlProfileRequestContext), flowExecutionContext.getKey().toString())}">
+        <on-render>
+            <evaluate expression="opensamlProfileRequestContext.getSubcontext(T(net.shibboleth.idp.authn.context.AuthenticationContext)).addSubcontext(new net.shibboleth.idp.authn.context.ExternalAuthenticationContext(), true).setFlowExecutionUrl(flowExecutionUrl + '&amp;_eventId_proceed=1')" />
+            <evaluate expression="externalContext.getNativeRequest().getSession().setAttribute('conversation' + flowExecutionContext.getKey().toString(), new net.shibboleth.idp.authn.impl.ExternalAuthenticationImpl(opensamlProfileRequestContext, calledAsExtendedFlow?:false))" />
+        </on-render>
+        <transition to="ValidateExternalAuthentication" />
+    </view-state>
+
+    <action-state id="ValidateExternalAuthentication">
+        <evaluate expression="ValidateExternalAuthentication" />
+        <evaluate expression="PopulateSubjectCanonicalizationContext" />
+        <evaluate expression="'proceed'" />
+
+        <transition on="proceed" to="CallSubjectCanonicalization" />
+    </action-state>
+
+    <!-- This runs a c14n step on the result of the authentication. -->
+    <subflow-state id="CallSubjectCanonicalization" subflow="c14n">
+        <input name="calledAsSubflow" value="true" />
+        <transition on="proceed" to="proceed" />
+
+        <!-- This shouldn't generally happen, but if c14n fails, it's allowable to fall through. -->
+        <transition on="SubjectCanonicalizationError" to="ReselectFlow" />
+    </subflow-state>
+
+    <bean-import resource="oxauth-authn-beans.xml" />
+
+</flow>
diff -aurN --ignore-all-space shibboleth-idp-3.3.3.orig/flows/authn/oxAuth/oxauth-supported-principals.xml shibboleth-idp-3.3.3.gluu/flows/authn/oxAuth/oxauth-supported-principals.xml
--- shibboleth-idp-3.3.3.orig/flows/authn/oxAuth/oxauth-supported-principals.xml	1970-01-01 03:00:00.000000000 +0300
+++ shibboleth-idp-3.3.3.gluu/flows/authn/oxAuth/oxauth-supported-principals.xml	2019-02-22 10:08:15.539180300 +0300
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<beans xmlns="http://www.springframework.org/schema/beans"
+       xmlns:context="http://www.springframework.org/schema/context"
+       xmlns:util="http://www.springframework.org/schema/util"
+       xmlns:p="http://www.springframework.org/schema/p"
+       xmlns:c="http://www.springframework.org/schema/c"
+       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
+                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
+                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"
+       default-init-method="initialize"
+       default-destroy-method="destroy">
+
+          <bean id="authn/oxAuth" parent="shibboleth.AuthenticationFlow"
+                p:forcedAuthenticationSupported="true"
+                p:nonBrowserSupported="false" >
+            <property name="supportedPrincipals">
+                <list>
+                    <bean parent="shibboleth.SAML2AuthnContextClassRef"
+                        c:classRef="urn:oasis:names:tc:SAML:2.0:ac:classes:InternetProtocol" />
+                    <bean parent="shibboleth.SAML2AuthnContextClassRef"
+                        c:classRef="urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport" />
+                    <bean parent="shibboleth.SAML2AuthnContextClassRef"
+                        c:classRef="urn:oasis:names:tc:SAML:2.0:ac:classes:Password" />
+                </list>
+            </property>
+          </bean>
+</beans>
